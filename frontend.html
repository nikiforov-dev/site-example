<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Логи активности и чат</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Общие стили */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding-bottom: 40px;
        }
        /* Фиксированная шапка */
        #fixedHeader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #fff;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
            text-align: center;
        }
        #fixedHeader h1 {
            margin: 0;
            font-size: 1.8rem;
            color: #343a40;
        }
        #fixedHeader #totalDuration {
            font-size: 1.1rem;
            font-weight: 500;
            color: #495057;
        }
        /* Основное содержимое */
        .content-container {
            margin-top: 120px;
        }
        /* Стили для карточек логов */
        .card {
            width: 30rem;
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease-in-out;
            margin-bottom: 20px;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-title {
            font-weight: 700;
            font-size: 1.25rem;
        }
        /* Цвета для логов */
        .active-log {
            background-color: #e0e0e0;
        }
        .finished-log {
            background-color: #d4edda;
        }
        /* Контейнер карточек */
        .card-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 40px;
        }
        /* Переходы для кнопок */
        .btn {
            transition: background-color 0.2s ease, filter 0.2s ease;
        }
        .btn:hover {
            filter: brightness(0.95);
        }
        /* Модальные окна */
        .modal-content {
            border-radius: 12px;
        }
        /* Плавающая кнопка "Вниз" */
        #scrollDownButton {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 1100;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 18px;
            padding: 0;
        }
        /* Плавающая кнопка переключения чата */
        #toggleChatButton {
            position: fixed;
            right: 80px;
            bottom: 20px;
            z-index: 1100;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 16px;
            padding: 0;
        }
        /* Стили для чата */
        #chatContainer {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;  /* чат скрыт по умолчанию */
            flex-direction: column;
            z-index: 1100;
        }
        #chatHeader {
            background: #007bff;
            color: #fff;
            padding: 10px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            font-size: 1.1rem;
        }
        #chatMessages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background: #f9f9f9;
        }
        #chatInputContainer {
            display: flex;
            flex-direction: column;
            border-top: 1px solid #ddd;
            padding: 10px;
            background: #fff;
        }
        /* Поля ввода в чате */
        /* Убираем поле для ввода имени пользователя */
        #chatInputContainer textarea {
            margin-bottom: 5px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            resize: vertical;
            font-size: 1rem;
        }
    </style>
</head>
<body>
<!-- Фиксированная шапка -->
<div id="fixedHeader">
    <h1>Логи активности</h1>
    <div id="totalDuration">
        Общее время: <span id="totalDurationValue">0 сек.</span>
    </div>
</div>

<!-- Основное содержимое страницы -->
<div class="container content-container">
    <!-- Контейнер для карточек логов -->
    <div id="logsContainer" class="card-container"></div>
    <!-- Кнопка создания нового лога -->
    <div class="text-center mb-5">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
            Создать новый лог
        </button>
    </div>
</div>

<!-- Плавающая кнопка для прокрутки вниз -->
<button id="scrollDownButton" class="btn btn-secondary" title="Перейти вниз">&#8595;</button>

<!-- Плавающая кнопка переключения чата -->
<button id="toggleChatButton" class="btn btn-secondary" title="Свернуть/Развернуть чат">Чат</button>

<!-- Плавающий чат (скрыт по умолчанию) -->
<div id="chatContainer">
    <div id="chatHeader">Чат</div>
    <div id="chatMessages"></div>
    <div id="chatInputContainer">
        <!-- Поле ввода только для сообщения -->
        <textarea id="chatMessage" placeholder="Ваше сообщение" rows="2"></textarea>
        <button id="chatSend" class="btn btn-primary btn-sm">Отправить</button>
    </div>
</div>

<!-- Modal создания лога -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="createModalLabel">Создать новый лог</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <form id="createLogForm">
                    <div class="mb-3">
                        <label for="createActivity" class="form-label">Название</label>
                        <input type="text" class="form-control" id="createActivity" required>
                    </div>
                    <div class="mb-3">
                        <label for="createDescription" class="form-label">Описание</label>
                        <textarea class="form-control" id="createDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="createLogButton">Создать</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal редактирования лога -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="editModalLabel">Редактировать лог</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <form id="editLogForm">
                    <input type="hidden" id="editLogId">
                    <div class="mb-3">
                        <label for="editActivity" class="form-label">Название</label>
                        <input type="text" class="form-control" id="editActivity" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Описание</label>
                        <textarea class="form-control" id="editDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editStartTime" class="form-label">Время начала</label>
                        <input type="datetime-local" class="form-control" id="editStartTime" step="1" required>
                    </div>
                    <div class="mb-3" id="editEndTimeContainer" style="display: none;">
                        <label for="editEndTime" class="form-label">Время окончания</label>
                        <input type="datetime-local" class="form-control" id="editEndTime" step="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="saveEditButton">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        let logsData = [];

        function pad(num) {
            return num < 10 ? "0" + num : num;
        }
        function formatDateTime(date) {
            return pad(date.getDate()) + "." + pad(date.getMonth() + 1) + "." + date.getFullYear() + " " +
                pad(date.getHours()) + ":" + pad(date.getMinutes()) + ":" + pad(date.getSeconds());
        }
        function formatDuration(seconds) {
            seconds = Math.floor(seconds);
            let days = Math.floor(seconds / 86400);
            seconds %= 86400;
            let hours = Math.floor(seconds / 3600);
            seconds %= 3600;
            let minutes = Math.floor(seconds / 60);
            let secs = seconds % 60;
            let parts = [];
            if (days > 0) parts.push(days + " д.");
            if (hours > 0) parts.push(hours + " ч.");
            if (minutes > 0) parts.push(minutes + " мин.");
            if (secs > 0 || parts.length === 0) parts.push(secs + " сек.");
            return parts.join(" ");
        }
        function toDateTimeLocal(dateStr) {
            let date = new Date(dateStr);
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            return date.toISOString().slice(0,19);
        }

        // Отрисовка карточки лога с получением имени пользователя по user_id
        function renderLogCard(log) {
            let card = document.createElement("div");
            card.className = "card mb-3 " + (log.end_time ? "finished-log" : "active-log");
            card.style.width = "30rem";
            card.dataset.logId = log.id;

            let cardBody = document.createElement("div");
            cardBody.className = "card-body";

            // Заголовок (Название лога)
            let titleEl = document.createElement("h5");
            titleEl.className = "card-title";
            titleEl.textContent = log.activity;
            cardBody.appendChild(titleEl);

            // Если в лог записи есть поле user, выводим его имя
            if (log.user) {
                let userInfo = document.createElement("p");
                userInfo.textContent = "Пользователь: " + log.user;
                cardBody.appendChild(userInfo);
            } else if (log.user_id) {
                // Если по каким-то причинам поле user не пришло, можно выполнить запрос:
                let userInfo = document.createElement("p");
                userInfo.textContent = "Пользователь: загрузка...";
                cardBody.appendChild(userInfo);
                fetch("/user/" + log.user_id)
                    .then(resp => resp.json())
                    .then(data => {
                        userInfo.textContent = "Пользователь: " + (data.name || "неизвестен");
                    })
                    .catch(err => {
                        console.error("Ошибка получения пользователя", err);
                        userInfo.textContent = "Пользователь: неизвестен";
                    });
            }

            // Кнопка показа/скрытия описания
            let toggleDescBtn = document.createElement("button");
            toggleDescBtn.className = "btn btn-sm btn-outline-secondary mb-2";
            toggleDescBtn.textContent = "Показать описание";
            cardBody.appendChild(toggleDescBtn);

            // Блок с описанием (скрыт по умолчанию)
            let descDiv = document.createElement("div");
            descDiv.className = "description";
            descDiv.textContent = log.description;
            descDiv.style.display = "none";
            cardBody.appendChild(descDiv);

            // Время начала
            let startTimeEl = document.createElement("p");
            let startDate = new Date(log.start_time);
            startTimeEl.textContent = "Время начала: " + formatDateTime(startDate);
            cardBody.appendChild(startTimeEl);

            // Время окончания (если лог завершён)
            let endTimeEl = document.createElement("p");
            if (log.end_time) {
                let endDate = new Date(log.end_time);
                endTimeEl.textContent = "Время окончания: " + formatDateTime(endDate);
            } else {
                endTimeEl.textContent = "Время окончания: -";
            }
            cardBody.appendChild(endTimeEl);

            // Залогированное время
            let durationEl = document.createElement("p");
            durationEl.innerHTML = "Залогированное время: <span class='log-duration' id='duration-" + log.id + "'></span>";
            cardBody.appendChild(durationEl);

            // Контейнер для кнопок
            let btnContainer = document.createElement("div");

            let editBtn = document.createElement("button");
            editBtn.className = "btn btn-sm btn-primary me-2";
            editBtn.textContent = "Редактировать";
            btnContainer.appendChild(editBtn);

            if (!log.end_time) {
                let finishBtn = document.createElement("button");
                finishBtn.className = "btn btn-sm btn-success";
                finishBtn.textContent = "Закончить";
                btnContainer.appendChild(finishBtn);
                finishBtn.addEventListener("click", function() {
                    finishLog(log.id);
                });
            }

            let deleteBtn = document.createElement("button");
            deleteBtn.className = "btn btn-sm btn-danger ms-2";
            deleteBtn.textContent = "Удалить";
            btnContainer.appendChild(deleteBtn);
            deleteBtn.addEventListener("click", function() {
                fetch("/logs/" + log.id, { method: "DELETE" })
                    .then(response => {
                        if(response.ok) {
                            loadLogs();
                            loadStats();
                        } else {
                            console.error("Ошибка удаления лога");
                        }
                    })
                    .catch(err => console.error("Ошибка:", err));
            });

            cardBody.appendChild(btnContainer);
            card.appendChild(cardBody);

            toggleDescBtn.addEventListener("click", function() {
                if (descDiv.style.display === "none") {
                    descDiv.style.display = "block";
                    toggleDescBtn.textContent = "Скрыть описание";
                } else {
                    descDiv.style.display = "none";
                    toggleDescBtn.textContent = "Показать описание";
                }
            });

            editBtn.addEventListener("click", function() {
                openEditModal(log);
            });

            updateDurationDisplay(log, card);
            return card;
        }

        function updateDurationDisplay(log, card) {
            let durationSpan = card.querySelector("#duration-" + log.id);
            let now = new Date();
            let durationSeconds;
            if (log.end_time) {
                durationSeconds = log.duration;
            } else {
                let start = new Date(log.start_time);
                durationSeconds = Math.floor((now - start) / 1000);
            }
            durationSpan.textContent = formatDuration(durationSeconds);
        }

        function loadLogs() {
            fetch("/logs")
                .then(response => response.json())
                .then(data => {
                    logsData = data;
                    let logsContainer = document.getElementById("logsContainer");
                    logsContainer.innerHTML = "";
                    data.forEach(log => {
                        let card = renderLogCard(log);
                        logsContainer.appendChild(card);
                    });
                })
                .catch(err => console.error("Ошибка загрузки логов:", err));
        }

        function loadStats() {
            fetch("/logs/stats")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("totalDurationValue").textContent = formatDuration(data.total_duration);
                })
                .catch(err => console.error("Ошибка загрузки статистики:", err));
        }

        function loadChatHistory() {
            fetch("/chat/messages")
                .then(response => response.json())
                .then(data => {
                    let chatMessages = document.getElementById("chatMessages");
                    chatMessages.innerHTML = "";
                    data.forEach(function(msg) {
                        addChatMessage(msg);
                    });
                    scrollChatToBottom();
                })
                .catch(err => console.error("Ошибка загрузки истории чата:", err));
        }

        function scrollChatToBottom() {
            let chatMessages = document.getElementById("chatMessages");
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        setInterval(function() {
            let logsContainer = document.getElementById("logsContainer");
            Array.from(logsContainer.children).forEach(card => {
                let logId = card.dataset.logId;
                let log = logsData.find(l => l.id == logId);
                if (log && !log.end_time) {
                    updateDurationDisplay(log, card);
                }
            });
        }, 1000);

        function finishLog(logId) {
            fetch("/logs/" + logId + "/finish", {
                method: "PUT"
            })
                .then(response => {
                    if (response.ok) {
                        loadLogs();
                        loadStats();
                    } else {
                        console.error("Ошибка завершения лога");
                    }
                })
                .catch(err => console.error("Ошибка:", err));
        }

        document.getElementById("createLogButton").addEventListener("click", function() {
            let activity = document.getElementById("createActivity").value.trim();
            let description = document.getElementById("createDescription").value.trim();
            if (!activity) {
                alert("Название обязательно");
                return;
            }
            let payload = { activity: activity, description: description };
            fetch("/logs", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
                .then(response => {
                    if (response.ok) {
                        let createModal = bootstrap.Modal.getInstance(document.getElementById("createModal"));
                        createModal.hide();
                        document.getElementById("createLogForm").reset();
                        loadLogs();
                        loadStats();
                    } else {
                        console.error("Ошибка создания лога");
                    }
                })
                .catch(err => console.error("Ошибка:", err));
        });

        function openEditModal(log) {
            document.getElementById("editLogId").value = log.id;
            document.getElementById("editActivity").value = log.activity;
            document.getElementById("editDescription").value = log.description;
            document.getElementById("editStartTime").value = toDateTimeLocal(log.start_time);
            if (log.end_time) {
                document.getElementById("editEndTimeContainer").style.display = "block";
                document.getElementById("editEndTime").value = toDateTimeLocal(log.end_time);
            } else {
                document.getElementById("editEndTimeContainer").style.display = "none";
                document.getElementById("editEndTime").value = "";
            }
            let editModal = new bootstrap.Modal(document.getElementById("editModal"));
            editModal.show();
        }

        document.getElementById("saveEditButton").addEventListener("click", function() {
            let logId = document.getElementById("editLogId").value;
            let activity = document.getElementById("editActivity").value.trim();
            let description = document.getElementById("editDescription").value.trim();
            let startTime = document.getElementById("editStartTime").value;
            let endTime = document.getElementById("editEndTime").value;
            if (!activity || !startTime) {
                alert("Название и время начала обязательны");
                return;
            }
            let payload = {
                activity: activity,
                description: description,
                start_time: new Date(startTime).toISOString()
            };
            if (endTime) {
                payload.end_time = new Date(endTime).toISOString();
            }
            fetch("/logs/" + logId, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
                .then(response => {
                    if (response.ok) {
                        let editModalEl = document.getElementById("editModal");
                        let modalInstance = bootstrap.Modal.getInstance(editModalEl);
                        modalInstance.hide();
                        loadLogs();
                        loadStats();
                    } else {
                        console.error("Ошибка обновления лога");
                    }
                })
                .catch(err => console.error("Ошибка:", err));
        });

        document.getElementById("scrollDownButton").addEventListener("click", function() {
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        });

        document.getElementById("toggleChatButton").addEventListener("click", function() {
            let chatContainer = document.getElementById("chatContainer");
            if (chatContainer.style.display === "none" || chatContainer.style.display === "") {
                chatContainer.style.display = "flex";
                scrollChatToBottom();
            } else {
                chatContainer.style.display = "none";
            }
        });

        /* Чат на WebSocket */
        let chatSocket;
        function initChat() {
            chatSocket = new WebSocket("ws://" + window.location.host + "/ws");
            chatSocket.onopen = function() {
                console.log("Чат: WebSocket соединение установлено");
            };
            chatSocket.onmessage = function(event) {
                let msg = JSON.parse(event.data);
                // Выводим имя пользователя и текст, если поле user присутствует
                addChatMessage(msg);
            };
            chatSocket.onclose = function() {
                console.log("Чат: WebSocket соединение закрыто. Попытка переподключения...");
                setTimeout(initChat, 3000);
            };
            chatSocket.onerror = function(error) {
                console.error("Чат: Ошибка WebSocket", error);
            };
        }

        function addChatMessage(msg) {
            let chatMessages = document.getElementById("chatMessages");
            let messageDiv = document.createElement("div");
            if (msg.user) {
                messageDiv.innerHTML = "<strong>" + msg.user + ":</strong> " + msg.text;
            } else {
                messageDiv.innerHTML = msg.text;
            }
            chatMessages.appendChild(messageDiv);
            scrollChatToBottom();
        }

        document.getElementById("chatSend").addEventListener("click", function() {
            let text = document.getElementById("chatMessage").value.trim();
            if (text === "") return;
            // Отправляем только текст сообщения
            let msg = { text: text };
            chatSocket.send(JSON.stringify(msg));
            document.getElementById("chatMessage").value = "";
        });

        document.getElementById("chatMessage").addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                document.getElementById("chatSend").click();
            }
        });

        initChat();
        loadChatHistory();
        loadLogs();
        loadStats();
    });
</script>
</body>
</html>
